function cov_10jtgd5wpa(){var path="C:\\Users\\Alex\\bootcamp\\collab\\skylab-bootcamp-202001\\staff\\alex-park\\poopinion\\poopinion-api\\logic\\publish-comment.js";var hash="54591ac8e3c8c172d0866e521f4f754154d21006";var global=new Function("return this")();var gcv="__coverage__";var coverageData={path:"C:\\Users\\Alex\\bootcamp\\collab\\skylab-bootcamp-202001\\staff\\alex-park\\poopinion\\poopinion-api\\logic\\publish-comment.js",statementMap:{"0":{start:{line:1,column:21},end:{line:1,column:47}},"1":{start:{line:2,column:46},end:{line:2,column:71}},"2":{start:{line:3,column:43},end:{line:3,column:70}},"3":{start:{line:19,column:0},end:{line:42,column:1}},"4":{start:{line:20,column:4},end:{line:20,column:29}},"5":{start:{line:21,column:4},end:{line:21,column:42}},"6":{start:{line:22,column:4},end:{line:22,column:43}},"7":{start:{line:24,column:4},end:{line:41,column:24}},"8":{start:{line:27,column:12},end:{line:27,column:83}},"9":{start:{line:27,column:23},end:{line:27,column:83}},"10":{start:{line:28,column:12},end:{line:28,column:96}},"11":{start:{line:28,column:34},end:{line:28,column:96}},"12":{start:{line:29,column:12},end:{line:29,column:93}},"13":{start:{line:29,column:25},end:{line:29,column:93}},"14":{start:{line:30,column:12},end:{line:30,column:128}},"15":{start:{line:30,column:33},end:{line:30,column:128}},"16":{start:{line:32,column:12},end:{line:32,column:54}},"17":{start:{line:32,column:34},end:{line:32,column:54}},"18":{start:{line:34,column:28},end:{line:34,column:108}},"19":{start:{line:36,column:12},end:{line:36,column:39}},"20":{start:{line:37,column:12},end:{line:37,column:41}},"21":{start:{line:39,column:12},end:{line:39,column:76}}},fnMap:{"0":{name:"(anonymous_0)",decl:{start:{line:19,column:17},end:{line:19,column:18}},loc:{start:{line:19,column:43},end:{line:42,column:1}},line:19},"1":{name:"(anonymous_1)",decl:{start:{line:25,column:14},end:{line:25,column:15}},loc:{start:{line:25,column:51},end:{line:40,column:9}},line:25},"2":{name:"(anonymous_2)",decl:{start:{line:41,column:14},end:{line:41,column:15}},loc:{start:{line:41,column:20},end:{line:41,column:23}},line:41}},branchMap:{"0":{loc:{start:{line:27,column:12},end:{line:27,column:83}},type:"if",locations:[{start:{line:27,column:12},end:{line:27,column:83}},{start:{line:27,column:12},end:{line:27,column:83}}],line:27},"1":{loc:{start:{line:28,column:12},end:{line:28,column:96}},type:"if",locations:[{start:{line:28,column:12},end:{line:28,column:96}},{start:{line:28,column:12},end:{line:28,column:96}}],line:28},"2":{loc:{start:{line:29,column:12},end:{line:29,column:93}},type:"if",locations:[{start:{line:29,column:12},end:{line:29,column:93}},{start:{line:29,column:12},end:{line:29,column:93}}],line:29},"3":{loc:{start:{line:30,column:12},end:{line:30,column:128}},type:"if",locations:[{start:{line:30,column:12},end:{line:30,column:128}},{start:{line:30,column:12},end:{line:30,column:128}}],line:30},"4":{loc:{start:{line:32,column:12},end:{line:32,column:54}},type:"if",locations:[{start:{line:32,column:12},end:{line:32,column:54}},{start:{line:32,column:12},end:{line:32,column:54}}],line:32}},s:{"0":0,"1":0,"2":0,"3":0,"4":0,"5":0,"6":0,"7":0,"8":0,"9":0,"10":0,"11":0,"12":0,"13":0,"14":0,"15":0,"16":0,"17":0,"18":0,"19":0,"20":0,"21":0},f:{"0":0,"1":0,"2":0},b:{"0":[0,0],"1":[0,0],"2":[0,0],"3":[0,0],"4":[0,0]},_coverageSchema:"1a1c01bbd47fc00a2c39e90264f33305004495a9",hash:"54591ac8e3c8c172d0866e521f4f754154d21006"};var coverage=global[gcv]||(global[gcv]={});if(!coverage[path]||coverage[path].hash!==hash){coverage[path]=coverageData;}var actualCoverage=coverage[path];cov_10jtgd5wpa=function(){return actualCoverage;};return actualCoverage;}cov_10jtgd5wpa();const{validate}=(cov_10jtgd5wpa().s[0]++,require('poopinion-utils'));const{models:{User,Toilet,Comment}}=(cov_10jtgd5wpa().s[1]++,require('poopinion-data'));const{NotAllowedError,NotFoundError}=(cov_10jtgd5wpa().s[2]++,require('poopinion-errors'));/**
 * Publish a new comment with rating on a toilet post
 * 
 * @param {string} id user's unique id
 * @param {string} toiletId toilet's unique id
 * @param {object} rating different ratings for the toilet
 * 
 * @returns {Promise} returns an empty Promise on a successful comment publish
 * 
 * @throws {NotAllowedError} if the user exists but has the property 'deactivated' as true
 * @throws {NotAllowedError} if the user already commented on specific toilet
 * @throws {NotFoundError} if the user or the toilet do not exist
 */cov_10jtgd5wpa().s[3]++;module.exports=(id,toiletId,rating)=>{cov_10jtgd5wpa().f[0]++;cov_10jtgd5wpa().s[4]++;validate.string(id,'id');cov_10jtgd5wpa().s[5]++;validate.string(toiletId,'toilet ID');cov_10jtgd5wpa().s[6]++;validate.type(rating,'rating',Object);cov_10jtgd5wpa().s[7]++;return Promise.all([User.findById(id),Toilet.findById({_id:toiletId}),Comment.findOne({publisher:id,commentedAt:toiletId})]).then(([user,toilet,repeatedComment])=>{cov_10jtgd5wpa().f[1]++;cov_10jtgd5wpa().s[8]++;if(!user){cov_10jtgd5wpa().b[0][0]++;cov_10jtgd5wpa().s[9]++;throw new NotFoundError(`user with id ${id} does not exist`);}else{cov_10jtgd5wpa().b[0][1]++;}cov_10jtgd5wpa().s[10]++;if(user.deactivated){cov_10jtgd5wpa().b[1][0]++;cov_10jtgd5wpa().s[11]++;throw new NotAllowedError(`user with id ${id} is deactivated`);}else{cov_10jtgd5wpa().b[1][1]++;}cov_10jtgd5wpa().s[12]++;if(!toilet){cov_10jtgd5wpa().b[2][0]++;cov_10jtgd5wpa().s[13]++;throw new NotFoundError(`toilet with id ${toiletId} does not exist`);}else{cov_10jtgd5wpa().b[2][1]++;}cov_10jtgd5wpa().s[14]++;if(repeatedComment){cov_10jtgd5wpa().b[3][0]++;cov_10jtgd5wpa().s[15]++;throw new NotAllowedError(`user with id ${id} already commented on toilet with id ${toiletId}`);}else{cov_10jtgd5wpa().b[3][1]++;}cov_10jtgd5wpa().s[16]++;if(!rating.textArea){cov_10jtgd5wpa().b[4][0]++;cov_10jtgd5wpa().s[17]++;rating.textArea='';}else{cov_10jtgd5wpa().b[4][1]++;}const comment=(cov_10jtgd5wpa().s[18]++,new Comment({publisher:id,created:new Date(),commentedAt:toiletId,rating}));cov_10jtgd5wpa().s[19]++;user.comments.push(comment);cov_10jtgd5wpa().s[20]++;toilet.comments.push(comment);cov_10jtgd5wpa().s[21]++;return Promise.all([user.save(),toilet.save(),comment.save()]);}).then(()=>{cov_10jtgd5wpa().f[2]++;});};
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInB1Ymxpc2gtY29tbWVudC5qcyJdLCJuYW1lcyI6WyJ2YWxpZGF0ZSIsInJlcXVpcmUiLCJtb2RlbHMiLCJVc2VyIiwiVG9pbGV0IiwiQ29tbWVudCIsIk5vdEFsbG93ZWRFcnJvciIsIk5vdEZvdW5kRXJyb3IiLCJtb2R1bGUiLCJleHBvcnRzIiwiaWQiLCJ0b2lsZXRJZCIsInJhdGluZyIsInN0cmluZyIsInR5cGUiLCJPYmplY3QiLCJQcm9taXNlIiwiYWxsIiwiZmluZEJ5SWQiLCJfaWQiLCJmaW5kT25lIiwicHVibGlzaGVyIiwiY29tbWVudGVkQXQiLCJ0aGVuIiwidXNlciIsInRvaWxldCIsInJlcGVhdGVkQ29tbWVudCIsImRlYWN0aXZhdGVkIiwidGV4dEFyZWEiLCJjb21tZW50IiwiY3JlYXRlZCIsIkRhdGUiLCJjb21tZW50cyIsInB1c2giLCJzYXZlIl0sIm1hcHBpbmdzIjoiMm5IQUFBLEtBQU0sQ0FBRUEsUUFBRiwyQkFBZUMsT0FBTyxDQUFDLGlCQUFELENBQXRCLENBQU4sQ0FDQSxLQUFNLENBQUVDLE1BQU0sQ0FBRSxDQUFFQyxJQUFGLENBQVFDLE1BQVIsQ0FBZ0JDLE9BQWhCLENBQVYsMkJBQXdDSixPQUFPLENBQUMsZ0JBQUQsQ0FBL0MsQ0FBTixDQUNBLEtBQU0sQ0FBRUssZUFBRixDQUFtQkMsYUFBbkIsMkJBQXFDTixPQUFPLENBQUMsa0JBQUQsQ0FBNUMsQ0FBTixDQUVBOzs7Ozs7Ozs7Ozs7MkJBY0FPLE1BQU0sQ0FBQ0MsT0FBUCxDQUFpQixDQUFDQyxFQUFELENBQUtDLFFBQUwsQ0FBZUMsTUFBZixHQUEwQixpREFDdkNaLFFBQVEsQ0FBQ2EsTUFBVCxDQUFnQkgsRUFBaEIsQ0FBb0IsSUFBcEIsRUFEdUMsd0JBRXZDVixRQUFRLENBQUNhLE1BQVQsQ0FBZ0JGLFFBQWhCLENBQTBCLFdBQTFCLEVBRnVDLHdCQUd2Q1gsUUFBUSxDQUFDYyxJQUFULENBQWNGLE1BQWQsQ0FBc0IsUUFBdEIsQ0FBZ0NHLE1BQWhDLEVBSHVDLHdCQUt2QyxNQUFPQyxDQUFBQSxPQUFPLENBQUNDLEdBQVIsQ0FBWSxDQUFDZCxJQUFJLENBQUNlLFFBQUwsQ0FBY1IsRUFBZCxDQUFELENBQW9CTixNQUFNLENBQUNjLFFBQVAsQ0FBZ0IsQ0FBRUMsR0FBRyxDQUFFUixRQUFQLENBQWhCLENBQXBCLENBQXdETixPQUFPLENBQUNlLE9BQVIsQ0FBZ0IsQ0FBRUMsU0FBUyxDQUFFWCxFQUFiLENBQWlCWSxXQUFXLENBQUVYLFFBQTlCLENBQWhCLENBQXhELENBQVosRUFDRlksSUFERSxDQUNHLENBQUMsQ0FBQ0MsSUFBRCxDQUFPQyxNQUFQLENBQWVDLGVBQWYsQ0FBRCxHQUFxQyxpREFFdkMsR0FBSSxDQUFDRixJQUFMLENBQVcseURBQU0sSUFBSWpCLENBQUFBLGFBQUosQ0FBbUIsZ0JBQWVHLEVBQUcsaUJBQXJDLENBQU4sQ0FBNEQsQ0FBdkUsaUNBRnVDLHlCQUd2QyxHQUFJYyxJQUFJLENBQUNHLFdBQVQsQ0FBc0IsMERBQU0sSUFBSXJCLENBQUFBLGVBQUosQ0FBcUIsZ0JBQWVJLEVBQUcsaUJBQXZDLENBQU4sQ0FBOEQsQ0FBcEYsaUNBSHVDLHlCQUl2QyxHQUFJLENBQUNlLE1BQUwsQ0FBYSwwREFBTSxJQUFJbEIsQ0FBQUEsYUFBSixDQUFtQixrQkFBaUJJLFFBQVMsaUJBQTdDLENBQU4sQ0FBb0UsQ0FBakYsaUNBSnVDLHlCQUt2QyxHQUFJZSxlQUFKLENBQXFCLDBEQUFNLElBQUlwQixDQUFBQSxlQUFKLENBQXFCLGdCQUFlSSxFQUFHLHdDQUF1Q0MsUUFBUyxFQUF2RixDQUFOLENBQStGLENBQXBILGlDQUx1Qyx5QkFPdkMsR0FBSSxDQUFDQyxNQUFNLENBQUNnQixRQUFaLENBQXNCLHFEQUFBaEIsTUFBTSxDQUFDZ0IsUUFBUCxDQUFrQixFQUFsQixDQUFvQixDQUExQyxpQ0FFQSxLQUFNQyxDQUFBQSxPQUFPLDJCQUFHLEdBQUl4QixDQUFBQSxPQUFKLENBQVksQ0FBRWdCLFNBQVMsQ0FBRVgsRUFBYixDQUFpQm9CLE9BQU8sQ0FBRSxHQUFJQyxDQUFBQSxJQUFKLEVBQTFCLENBQW9DVCxXQUFXLENBQUVYLFFBQWpELENBQTJEQyxNQUEzRCxDQUFaLENBQUgsQ0FBYixDQVR1Qyx5QkFXdkNZLElBQUksQ0FBQ1EsUUFBTCxDQUFjQyxJQUFkLENBQW1CSixPQUFuQixFQVh1Qyx5QkFZdkNKLE1BQU0sQ0FBQ08sUUFBUCxDQUFnQkMsSUFBaEIsQ0FBcUJKLE9BQXJCLEVBWnVDLHlCQWN2QyxNQUFPYixDQUFBQSxPQUFPLENBQUNDLEdBQVIsQ0FBWSxDQUFDTyxJQUFJLENBQUNVLElBQUwsRUFBRCxDQUFjVCxNQUFNLENBQUNTLElBQVAsRUFBZCxDQUE2QkwsT0FBTyxDQUFDSyxJQUFSLEVBQTdCLENBQVosQ0FBUCxDQUNILENBaEJFLEVBaUJGWCxJQWpCRSxDQWlCRyxJQUFNLHlCQUFHLENBakJaLENBQVAsQ0FrQkgsQ0F2QkQiLCJzb3VyY2VzQ29udGVudCI6WyJjb25zdCB7IHZhbGlkYXRlIH0gPSByZXF1aXJlKCdwb29waW5pb24tdXRpbHMnKVxyXG5jb25zdCB7IG1vZGVsczogeyBVc2VyLCBUb2lsZXQsIENvbW1lbnQgfSB9ID0gcmVxdWlyZSgncG9vcGluaW9uLWRhdGEnKVxyXG5jb25zdCB7IE5vdEFsbG93ZWRFcnJvciwgTm90Rm91bmRFcnJvciB9ID0gcmVxdWlyZSgncG9vcGluaW9uLWVycm9ycycpXHJcblxyXG4vKipcclxuICogUHVibGlzaCBhIG5ldyBjb21tZW50IHdpdGggcmF0aW5nIG9uIGEgdG9pbGV0IHBvc3RcclxuICogXHJcbiAqIEBwYXJhbSB7c3RyaW5nfSBpZCB1c2VyJ3MgdW5pcXVlIGlkXHJcbiAqIEBwYXJhbSB7c3RyaW5nfSB0b2lsZXRJZCB0b2lsZXQncyB1bmlxdWUgaWRcclxuICogQHBhcmFtIHtvYmplY3R9IHJhdGluZyBkaWZmZXJlbnQgcmF0aW5ncyBmb3IgdGhlIHRvaWxldFxyXG4gKiBcclxuICogQHJldHVybnMge1Byb21pc2V9IHJldHVybnMgYW4gZW1wdHkgUHJvbWlzZSBvbiBhIHN1Y2Nlc3NmdWwgY29tbWVudCBwdWJsaXNoXHJcbiAqIFxyXG4gKiBAdGhyb3dzIHtOb3RBbGxvd2VkRXJyb3J9IGlmIHRoZSB1c2VyIGV4aXN0cyBidXQgaGFzIHRoZSBwcm9wZXJ0eSAnZGVhY3RpdmF0ZWQnIGFzIHRydWVcclxuICogQHRocm93cyB7Tm90QWxsb3dlZEVycm9yfSBpZiB0aGUgdXNlciBhbHJlYWR5IGNvbW1lbnRlZCBvbiBzcGVjaWZpYyB0b2lsZXRcclxuICogQHRocm93cyB7Tm90Rm91bmRFcnJvcn0gaWYgdGhlIHVzZXIgb3IgdGhlIHRvaWxldCBkbyBub3QgZXhpc3RcclxuICovXHJcblxyXG5tb2R1bGUuZXhwb3J0cyA9IChpZCwgdG9pbGV0SWQsIHJhdGluZykgPT4ge1xyXG4gICAgdmFsaWRhdGUuc3RyaW5nKGlkLCAnaWQnKVxyXG4gICAgdmFsaWRhdGUuc3RyaW5nKHRvaWxldElkLCAndG9pbGV0IElEJylcclxuICAgIHZhbGlkYXRlLnR5cGUocmF0aW5nLCAncmF0aW5nJywgT2JqZWN0KVxyXG5cclxuICAgIHJldHVybiBQcm9taXNlLmFsbChbVXNlci5maW5kQnlJZChpZCksIFRvaWxldC5maW5kQnlJZCh7IF9pZDogdG9pbGV0SWQgfSksIENvbW1lbnQuZmluZE9uZSh7IHB1Ymxpc2hlcjogaWQsIGNvbW1lbnRlZEF0OiB0b2lsZXRJZCB9KV0pXHJcbiAgICAgICAgLnRoZW4oKFt1c2VyLCB0b2lsZXQsIHJlcGVhdGVkQ29tbWVudF0pID0+IHtcclxuXHJcbiAgICAgICAgICAgIGlmICghdXNlcikgdGhyb3cgbmV3IE5vdEZvdW5kRXJyb3IoYHVzZXIgd2l0aCBpZCAke2lkfSBkb2VzIG5vdCBleGlzdGApXHJcbiAgICAgICAgICAgIGlmICh1c2VyLmRlYWN0aXZhdGVkKSB0aHJvdyBuZXcgTm90QWxsb3dlZEVycm9yKGB1c2VyIHdpdGggaWQgJHtpZH0gaXMgZGVhY3RpdmF0ZWRgKVxyXG4gICAgICAgICAgICBpZiAoIXRvaWxldCkgdGhyb3cgbmV3IE5vdEZvdW5kRXJyb3IoYHRvaWxldCB3aXRoIGlkICR7dG9pbGV0SWR9IGRvZXMgbm90IGV4aXN0YClcclxuICAgICAgICAgICAgaWYgKHJlcGVhdGVkQ29tbWVudCkgdGhyb3cgbmV3IE5vdEFsbG93ZWRFcnJvcihgdXNlciB3aXRoIGlkICR7aWR9IGFscmVhZHkgY29tbWVudGVkIG9uIHRvaWxldCB3aXRoIGlkICR7dG9pbGV0SWR9YClcclxuXHJcbiAgICAgICAgICAgIGlmICghcmF0aW5nLnRleHRBcmVhKSByYXRpbmcudGV4dEFyZWEgPSAnJ1xyXG5cclxuICAgICAgICAgICAgY29uc3QgY29tbWVudCA9IG5ldyBDb21tZW50KHsgcHVibGlzaGVyOiBpZCwgY3JlYXRlZDogbmV3IERhdGUsIGNvbW1lbnRlZEF0OiB0b2lsZXRJZCwgcmF0aW5nIH0pXHJcblxyXG4gICAgICAgICAgICB1c2VyLmNvbW1lbnRzLnB1c2goY29tbWVudClcclxuICAgICAgICAgICAgdG9pbGV0LmNvbW1lbnRzLnB1c2goY29tbWVudClcclxuXHJcbiAgICAgICAgICAgIHJldHVybiBQcm9taXNlLmFsbChbdXNlci5zYXZlKCksIHRvaWxldC5zYXZlKCksIGNvbW1lbnQuc2F2ZSgpXSlcclxuICAgICAgICB9KVxyXG4gICAgICAgIC50aGVuKCgpID0+IHsgfSlcclxufSJdfQ==